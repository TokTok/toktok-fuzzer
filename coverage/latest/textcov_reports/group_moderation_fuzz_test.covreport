_ZN3tox4test15NetworkUniverseC2Ev:
   24|     37|NetworkUniverse::NetworkUniverse() { }
_ZN3tox4test15NetworkUniverseD2Ev:
   25|     37|NetworkUniverse::~NetworkUniverse() { }

_ZNK3tox4test9Fuzz_Data4sizeEv:
   99|    241|    std::size_t size() const { return size_; }
_ZN3tox4test9Fuzz_Data8consume1EPKc:
   61|     93|    Consumer consume1(const char *func) { return Consumer{func, *this}; }
_ZN3tox4test9Fuzz_Data8ConsumercvT_ItEEv:
   51|     37|        {
   52|     37|            if (sizeof(T) > fd.size())
  ------------------
  |  Branch (52:17): [True: 0, False: 37]
  ------------------
   53|      0|                return T{};
   54|     37|            const uint8_t *bytes = fd.consume(func, sizeof(T));
   55|     37|            T val;
   56|     37|            std::memcpy(&val, bytes, sizeof(T));
   57|     37|            return val;
   58|     37|        }
_ZN3tox4test9Fuzz_Data7consumeEPKcm:
  105|     94|    {
  106|     94|        if (count > size_)
  ------------------
  |  Branch (106:13): [True: 0, False: 94]
  ------------------
  107|      0|            return nullptr;
  108|     94|        const uint8_t *val = data_;
  109|     94|        if (FUZZ_DEBUG) {
  ------------------
  |  Branch (109:13): [Folded, False: 94]
  ------------------
  110|      0|            if (count == 1) {
  ------------------
  |  Branch (110:17): [True: 0, False: 0]
  ------------------
  111|      0|                std::printf("consume@%zu(%s): %d (0x%02x)\n", pos(), func, val[0], val[0]);
  112|      0|            } else if (count != 0) {
  ------------------
  |  Branch (112:24): [True: 0, False: 0]
  ------------------
  113|      0|                std::printf("consume@%zu(%s): %02x..%02x[%zu]\n", pos(), func, val[0],
  114|      0|                    val[count - 1], count);
  115|      0|            }
  116|      0|        }
  117|     94|        data_ += count;
  118|     94|        size_ -= count;
  119|     94|        return val;
  120|     94|    }
_ZNK3tox4test9Fuzz_Data4dataEv:
  101|     52|    const uint8_t *data() const { return data_; }
group_moderation_fuzz_test.cc:_ZN3tox4test18fuzz_select_targetIJXadL_ZN12_GLOBAL__N_117TestModListUnpackERNS0_9Fuzz_DataEEEXadL_ZNS2_23TestSanctionsListUnpackES4_EEXadL_ZNS2_23TestSanctionCredsUnpackES4_EEEEEvPKhm:
  174|     56|{
  175|     56|    Fuzz_Data input{data, size};
  176|       |
  177|     56|    CONSUME1_OR_RETURN(const uint8_t, selector, input);
  ------------------
  |  |  124|     56|    if ((INPUT).size() < sizeof(TYPE)) {      \
  |  |  ------------------
  |  |  |  Branch (124:9): [True: 0, False: 56]
  |  |  ------------------
  |  |  125|      0|        return;                               \
  |  |  126|      0|    }                                         \
  |  |  127|     56|    TYPE NAME = (INPUT).consume1(__func__)
  ------------------
  178|     56|    return Fuzz_Target_Selector<Args...>::select(selector, input);
  179|     56|}
_ZN3tox4test9Fuzz_DataC2EPKhm:
   23|     56|        : data_(input_data)
   24|     56|        , base_(input_data)
   25|     56|        , size_(input_size)
   26|     56|    {
   27|     56|    }
_ZN3tox4test9Fuzz_Data8ConsumercvT_IhEEv:
   51|     56|        {
   52|     56|            if (sizeof(T) > fd.size())
  ------------------
  |  Branch (52:17): [True: 0, False: 56]
  ------------------
   53|      0|                return T{};
   54|     56|            const uint8_t *bytes = fd.consume(func, sizeof(T));
   55|     56|            T val;
   56|     56|            std::memcpy(&val, bytes, sizeof(T));
   57|     56|            return val;
   58|     56|        }
group_moderation_fuzz_test.cc:_ZN3tox4test20Fuzz_Target_SelectorIJXadL_ZN12_GLOBAL__N_117TestModListUnpackERNS0_9Fuzz_DataEEEXadL_ZNS2_23TestSanctionsListUnpackES4_EEXadL_ZNS2_23TestSanctionCredsUnpackES4_EEEE6selectEhS4_:
  155|     56|    {
  156|     56|        if (selector == sizeof...(Args)) {
  ------------------
  |  Branch (156:13): [True: 38, False: 18]
  ------------------
  157|     38|            return Arg(input);
  158|     38|        }
  159|     18|        return Fuzz_Target_Selector<Args...>::select(selector, input);
  160|     56|    }
group_moderation_fuzz_test.cc:_ZN3tox4test20Fuzz_Target_SelectorIJXadL_ZN12_GLOBAL__N_123TestSanctionsListUnpackERNS0_9Fuzz_DataEEEXadL_ZNS2_23TestSanctionCredsUnpackES4_EEEE6selectEhS4_:
  155|     18|    {
  156|     18|        if (selector == sizeof...(Args)) {
  ------------------
  |  Branch (156:13): [True: 15, False: 3]
  ------------------
  157|     15|            return Arg(input);
  158|     15|        }
  159|      3|        return Fuzz_Target_Selector<Args...>::select(selector, input);
  160|     18|    }
group_moderation_fuzz_test.cc:_ZN3tox4test20Fuzz_Target_SelectorIJXadL_ZN12_GLOBAL__N_123TestSanctionCredsUnpackERNS0_9Fuzz_DataEEEEE6selectEhS4_:
  155|      3|    {
  156|      3|        if (selector == sizeof...(Args)) {
  ------------------
  |  Branch (156:13): [True: 2, False: 1]
  ------------------
  157|      2|            return Arg(input);
  158|      2|        }
  159|      1|        return Fuzz_Target_Selector<Args...>::select(selector, input);
  160|      3|    }
_ZN3tox4test20Fuzz_Target_SelectorIJEE6selectEhRNS0_9Fuzz_DataE:
  166|      1|    {
  167|       |        // The selector selected no function, so we do nothing and rely on the
  168|       |        // fuzzer to come up with a better selector.
  169|      1|    }

_ZN3tox4test11ClockSystemD2Ev:
    5|     37|ClockSystem::~ClockSystem() = default;

_ZN3tox4test11EnvironmentD2Ev:
    5|     37|Environment::~Environment() = default;

_ZN3tox4test9FakeClockC2Em:
    6|     37|    : now_ms_(start_time_ms)
    7|     37|{
    8|     37|}

_ZN3tox4test10FakeMemoryC2Ev:
   24|     37|FakeMemory::FakeMemory() = default;
_ZN3tox4test10FakeMemoryD2Ev:
   25|     37|FakeMemory::~FakeMemory() = default;
_ZN3tox4test10FakeMemory6mallocEm:
   28|  1.76k|{
   29|  1.76k|    bool fail = failure_injector_ && failure_injector_(size);
  ------------------
  |  Branch (29:17): [True: 0, False: 1.76k]
  |  Branch (29:38): [True: 0, False: 0]
  ------------------
   30|       |
   31|  1.76k|    if (observer_) {
  ------------------
  |  Branch (31:9): [True: 0, False: 1.76k]
  ------------------
   32|      0|        observer_(!fail);
   33|      0|    }
   34|       |
   35|  1.76k|    if (fail) {
  ------------------
  |  Branch (35:9): [True: 0, False: 1.76k]
  ------------------
   36|      0|        return nullptr;
   37|      0|    }
   38|       |
   39|  1.76k|    void *ptr = std::malloc(size + sizeof(Header));
   40|  1.76k|    if (!ptr) {
  ------------------
  |  Branch (40:9): [True: 0, False: 1.76k]
  ------------------
   41|      0|        return nullptr;
   42|      0|    }
   43|       |
   44|  1.76k|    Header *header = static_cast<Header *>(ptr);
   45|  1.76k|    header->size = size;
   46|  1.76k|    header->magic = kMagic;
   47|       |
   48|  1.76k|    on_allocation(size);
   49|       |
   50|  1.76k|    return header + 1;
   51|  1.76k|}
_ZN3tox4test10FakeMemory4freeEPv:
   99|  1.76k|{
  100|  1.76k|    if (!ptr) {
  ------------------
  |  Branch (100:9): [True: 0, False: 1.76k]
  ------------------
  101|      0|        return;
  102|      0|    }
  103|       |
  104|  1.76k|    Header *header = static_cast<Header *>(ptr) - 1;
  105|  1.76k|    if (header->magic != kMagic) {
  ------------------
  |  Branch (105:9): [True: 0, False: 1.76k]
  ------------------
  106|      0|        if (header->magic == kFreeMagic) {
  ------------------
  |  Branch (106:13): [True: 0, False: 0]
  ------------------
  107|      0|            std::cerr << "[FakeMemory] free: Double free detected at " << ptr
  108|      0|                      << " (header=" << header << ")" << std::endl;
  109|      0|        } else {
  110|      0|            std::cerr << "[FakeMemory] free: Invalid pointer (wrong magic 0x" << std::hex
  111|      0|                      << header->magic << ") at " << ptr << " (header=" << header << ")"
  112|      0|                      << std::endl;
  113|      0|        }
  114|      0|        std::abort();
  115|      0|    }
  116|       |
  117|  1.76k|    size_t size = header->size;
  118|  1.76k|    on_deallocation(size);
  119|  1.76k|    header->magic = kFreeMagic;  // Mark as free
  120|  1.76k|    std::free(header);
  121|  1.76k|}
_ZN3tox4test10FakeMemory8c_memoryEv:
  130|     37|struct Memory FakeMemory::c_memory() { return Memory{&kFakeMemoryVtable, this}; }
_ZN3tox4test10FakeMemory13on_allocationEm:
  137|  1.76k|{
  138|  1.76k|    size_t current = current_allocation_.fetch_add(size) + size;
  139|  1.76k|    size_t max = max_allocation_.load(std::memory_order_relaxed);
  140|  1.76k|    while (current > max && !max_allocation_.compare_exchange_weak(max, current)) { }
  ------------------
  |  Branch (140:12): [True: 1.76k, False: 0]
  |  Branch (140:29): [True: 0, False: 1.76k]
  ------------------
  141|  1.76k|}
_ZN3tox4test10FakeMemory15on_deallocationEm:
  143|  1.76k|void FakeMemory::on_deallocation(size_t size) { current_allocation_.fetch_sub(size); }
fake_memory.cc:_ZNK3tox4test3$_0clEPvj:
   15|  1.76k|    = [](void *obj, uint32_t size) { return static_cast<FakeMemory *>(obj)->malloc(size); },
fake_memory.cc:_ZNK3tox4test3$_2clEPvS2_:
   19|  1.76k|    .dealloc_callback = [](void *obj, void *ptr) { static_cast<FakeMemory *>(obj)->free(ptr); },

_ZN3tox4test10FakeRandomC2Em:
   21|     37|    : rng_(seed)
   22|     37|{
   23|     37|}

_ZN3tox4test12MemorySystemD2Ev:
    5|     37|MemorySystem::~MemorySystem() = default;

_ZN3tox4test12RandomSystemD2Ev:
    5|     37|RandomSystem::~RandomSystem() = default;

_ZN3tox4test20SimulatedEnvironmentC2Ev:
    8|     37|    : sim_(std::make_unique<Simulation>())
    9|     37|    , global_random_(std::make_unique<FakeRandom>(12345))
   10|     37|    , global_memory_(std::make_unique<FakeMemory>())
   11|     37|{
   12|     37|}
_ZN3tox4test20SimulatedEnvironmentD2Ev:
   14|     37|SimulatedEnvironment::~SimulatedEnvironment() = default;
_ZN3tox4test20SimulatedEnvironment11fake_memoryEv:
   34|     37|FakeMemory &SimulatedEnvironment::fake_memory() { return *global_memory_; }

_ZN3tox4test10SimulationC2Ev:
   13|     37|    : clock_(std::make_unique<FakeClock>())
   14|     37|    , net_(std::make_unique<NetworkUniverse>())
   15|     37|{
   16|     37|}
_ZN3tox4test10SimulationD2Ev:
   18|     37|Simulation::~Simulation() = default;

mod_list_unpack:
   69|     37|{
   70|     37|    if (length < num_mods * MOD_LIST_ENTRY_SIZE) {
  ------------------
  |  |   27|     37|#define MOD_LIST_ENTRY_SIZE SIG_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   95|     37|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|     37|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
  |  Branch (70:9): [True: 1, False: 36]
  ------------------
   71|      1|        return -1;
   72|      1|    }
   73|       |
   74|     36|    mod_list_cleanup(moderation);
   75|       |
   76|     36|    if (num_mods == 0) {
  ------------------
  |  Branch (76:9): [True: 1, False: 35]
  ------------------
   77|      1|        return 0;
   78|      1|    }
   79|       |
   80|     35|    uint8_t **tmp_list = (uint8_t **)mem_valloc(moderation->mem, num_mods, sizeof(uint8_t *));
   81|       |
   82|     35|    if (tmp_list == nullptr) {
  ------------------
  |  |   63|     35|#define nullptr NULL
  ------------------
  |  Branch (82:9): [True: 0, False: 35]
  ------------------
   83|      0|        return -1;
   84|      0|    }
   85|       |
   86|     35|    uint16_t unpacked_len = 0;
   87|       |
   88|  1.76k|    for (uint16_t i = 0; i < num_mods; ++i) {
  ------------------
  |  Branch (88:26): [True: 1.72k, False: 35]
  ------------------
   89|  1.72k|        uint8_t *entry = (uint8_t *)mem_balloc(moderation->mem, MOD_LIST_ENTRY_SIZE);
  ------------------
  |  |   27|  1.72k|#define MOD_LIST_ENTRY_SIZE SIG_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   95|  1.72k|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|  1.72k|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
   90|       |
   91|  1.72k|        if (entry == nullptr) {
  ------------------
  |  |   63|  1.72k|#define nullptr NULL
  ------------------
  |  Branch (91:13): [True: 0, False: 1.72k]
  ------------------
   92|      0|            free_uint8_t_pointer_array(moderation->mem, tmp_list, i);
   93|      0|            return -1;
   94|      0|        }
   95|       |
   96|  1.72k|        memcpy(entry, &data[i * MOD_LIST_ENTRY_SIZE], MOD_LIST_ENTRY_SIZE);
  ------------------
  |  |   27|  1.72k|#define MOD_LIST_ENTRY_SIZE SIG_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   95|  1.72k|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|  1.72k|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
                      memcpy(entry, &data[i * MOD_LIST_ENTRY_SIZE], MOD_LIST_ENTRY_SIZE);
  ------------------
  |  |   27|  1.72k|#define MOD_LIST_ENTRY_SIZE SIG_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   95|  1.72k|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|  1.72k|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
   97|  1.72k|        tmp_list[i] = entry;
   98|       |
   99|  1.72k|        unpacked_len += MOD_LIST_ENTRY_SIZE;
  ------------------
  |  |   27|  1.72k|#define MOD_LIST_ENTRY_SIZE SIG_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   95|  1.72k|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|  1.72k|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
  100|  1.72k|    }
  101|       |
  102|     35|    moderation->mod_list = tmp_list;
  103|     35|    moderation->num_mods = num_mods;
  104|       |
  105|     35|    qsort(moderation->mod_list, moderation->num_mods, sizeof(uint8_t *), compare_mod_pointers);
  106|       |
  107|     35|    return unpacked_len;
  108|     35|}
mod_list_cleanup:
  262|     73|{
  263|     73|    free_uint8_t_pointer_array(moderation->mem, moderation->mod_list, moderation->num_mods);
  264|     73|    moderation->num_mods = 0;
  265|       |    moderation->mod_list = nullptr;
  ------------------
  |  |   63|     73|#define nullptr NULL
  ------------------
  266|     73|}
sanctions_creds_unpack:
  351|      2|{
  352|      2|    uint16_t len_processed = 0;
  353|       |
  354|      2|    net_unpack_u32(&data[len_processed], &creds->version);
  355|      2|    len_processed += sizeof(uint32_t);
  356|      2|    memcpy(creds->hash, &data[len_processed], MOD_SANCTION_HASH_SIZE);
  ------------------
  |  |   28|      2|#define MOD_SANCTION_HASH_SIZE CRYPTO_SHA256_SIZE
  |  |  ------------------
  |  |  |  |   75|      2|#define CRYPTO_SHA256_SIZE             32
  |  |  ------------------
  ------------------
  357|      2|    len_processed += MOD_SANCTION_HASH_SIZE;
  ------------------
  |  |   28|      2|#define MOD_SANCTION_HASH_SIZE CRYPTO_SHA256_SIZE
  |  |  ------------------
  |  |  |  |   75|      2|#define CRYPTO_SHA256_SIZE             32
  |  |  ------------------
  ------------------
  358|      2|    net_unpack_u16(&data[len_processed], &creds->checksum);
  359|      2|    len_processed += sizeof(uint16_t);
  360|      2|    memcpy(creds->sig_pk, &data[len_processed], SIG_PUBLIC_KEY_SIZE);
  ------------------
  |  |   95|      2|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   34|      2|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  ------------------
  ------------------
  361|      2|    len_processed += SIG_PUBLIC_KEY_SIZE;
  ------------------
  |  |   95|      2|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   34|      2|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  ------------------
  ------------------
  362|      2|    memcpy(creds->sig, &data[len_processed], SIGNATURE_SIZE);
  ------------------
  |  |   29|      2|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  ------------------
  |  |  |  |   29|      2|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  ------------------
  ------------------
  363|      2|    len_processed += SIGNATURE_SIZE;
  ------------------
  |  |   29|      2|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  ------------------
  |  |  |  |   29|      2|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  ------------------
  ------------------
  364|       |
  365|      2|    return len_processed;
  366|      2|}
sanctions_list_unpack:
  370|     15|{
  371|     15|    uint16_t num = 0;
  372|     15|    uint16_t len_processed = 0;
  373|       |
  374|     64|    while (num < max_sanctions && num < MOD_MAX_NUM_SANCTIONS && len_processed < length) {
  ------------------
  |  |   52|    126|#define MOD_MAX_NUM_SANCTIONS        (MOD_MAX_NUM_SANCTIONS_LIMIT / 12)
  |  |  ------------------
  |  |  |  |   49|     62|#define MOD_MAX_NUM_SANCTIONS_LIMIT  (((MAX_PACKET_SIZE_NO_HEADERS - (MOD_SANCTIONS_CREDS_SIZE)) / (MOD_SANCTION_PACKED_SIZE)))
  |  |  |  |  ------------------
  |  |  |  |  |  |   40|     62|#define MAX_PACKET_SIZE_NO_HEADERS 49900
  |  |  |  |  ------------------
  |  |  |  |               #define MOD_MAX_NUM_SANCTIONS_LIMIT  (((MAX_PACKET_SIZE_NO_HEADERS - (MOD_SANCTIONS_CREDS_SIZE)) / (MOD_SANCTION_PACKED_SIZE)))
  |  |  |  |  ------------------
  |  |  |  |  |  |   33|     62|#define MOD_SANCTIONS_CREDS_SIZE (sizeof(uint32_t) + MOD_SANCTION_HASH_SIZE + sizeof(uint16_t) +\
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   28|     62|#define MOD_SANCTION_HASH_SIZE CRYPTO_SHA256_SIZE
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |  |  |   75|     62|#define CRYPTO_SHA256_SIZE             32
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |   34|     62|                                       SIG_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   95|     62|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |  |  |   34|     62|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |                                                      SIG_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   29|     62|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |  |  |   29|     62|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  ------------------
  |  |  |  |  ------------------
  |  |  |  |               #define MOD_MAX_NUM_SANCTIONS_LIMIT  (((MAX_PACKET_SIZE_NO_HEADERS - (MOD_SANCTIONS_CREDS_SIZE)) / (MOD_SANCTION_PACKED_SIZE)))
  |  |  |  |  ------------------
  |  |  |  |  |  |   37|     62|#define MOD_SANCTION_PACKED_SIZE (SIG_PUBLIC_KEY_SIZE + TIME_STAMP_SIZE + 1 + ENC_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   95|     62|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |  |  |   34|     62|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |               #define MOD_SANCTION_PACKED_SIZE (SIG_PUBLIC_KEY_SIZE + TIME_STAMP_SIZE + 1 + ENC_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   30|     62|#define TIME_STAMP_SIZE sizeof(uint64_t)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |               #define MOD_SANCTION_PACKED_SIZE (SIG_PUBLIC_KEY_SIZE + TIME_STAMP_SIZE + 1 + ENC_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   85|     62|#define ENC_PUBLIC_KEY_SIZE            CRYPTO_PUBLIC_KEY_SIZE
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |  |  |   44|     62|#define CRYPTO_PUBLIC_KEY_SIZE         32
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |               #define MOD_SANCTION_PACKED_SIZE (SIG_PUBLIC_KEY_SIZE + TIME_STAMP_SIZE + 1 + ENC_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |   29|     62|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  |  |  |  |   29|     62|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  |  |  |  |  |  |  ------------------
  |  |  |  |  |  |  ------------------
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
  |  Branch (374:12): [True: 62, False: 2]
  |  Branch (374:35): [True: 62, False: 0]
  |  Branch (374:66): [True: 57, False: 5]
  ------------------
  375|     57|        if (len_processed + sizeof(uint8_t) + SIG_PUBLIC_KEY_SIZE + TIME_STAMP_SIZE > length) {
  ------------------
  |  |   95|     57|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   34|     57|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  ------------------
  ------------------
                      if (len_processed + sizeof(uint8_t) + SIG_PUBLIC_KEY_SIZE + TIME_STAMP_SIZE > length) {
  ------------------
  |  |   30|     57|#define TIME_STAMP_SIZE sizeof(uint64_t)
  ------------------
  |  Branch (375:13): [True: 1, False: 56]
  ------------------
  376|      1|            return -1;
  377|      1|        }
  378|       |
  379|     56|        memcpy(&sanctions[num].type, &data[len_processed], sizeof(uint8_t));
  380|     56|        len_processed += sizeof(uint8_t);
  381|     56|        memcpy(sanctions[num].setter_public_sig_key, &data[len_processed], SIG_PUBLIC_KEY_SIZE);
  ------------------
  |  |   95|     56|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   34|     56|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  ------------------
  ------------------
  382|     56|        len_processed += SIG_PUBLIC_KEY_SIZE;
  ------------------
  |  |   95|     56|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   34|     56|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  ------------------
  ------------------
  383|     56|        net_unpack_u64(&data[len_processed], &sanctions[num].time_set);
  384|     56|        len_processed += TIME_STAMP_SIZE;
  ------------------
  |  |   30|     56|#define TIME_STAMP_SIZE sizeof(uint64_t)
  ------------------
  385|       |
  386|     56|        if (sanctions[num].type == SA_OBSERVER) {
  ------------------
  |  Branch (386:13): [True: 52, False: 4]
  ------------------
  387|     52|            if (len_processed + ENC_PUBLIC_KEY_SIZE > length) {
  ------------------
  |  |   85|     52|#define ENC_PUBLIC_KEY_SIZE            CRYPTO_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   44|     52|#define CRYPTO_PUBLIC_KEY_SIZE         32
  |  |  ------------------
  ------------------
  |  Branch (387:17): [True: 2, False: 50]
  ------------------
  388|      2|                return -1;
  389|      2|            }
  390|       |
  391|     50|            memcpy(sanctions[num].target_public_enc_key, &data[len_processed], ENC_PUBLIC_KEY_SIZE);
  ------------------
  |  |   85|     50|#define ENC_PUBLIC_KEY_SIZE            CRYPTO_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   44|     50|#define CRYPTO_PUBLIC_KEY_SIZE         32
  |  |  ------------------
  ------------------
  392|     50|            len_processed += ENC_PUBLIC_KEY_SIZE;
  ------------------
  |  |   85|     50|#define ENC_PUBLIC_KEY_SIZE            CRYPTO_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   44|     50|#define CRYPTO_PUBLIC_KEY_SIZE         32
  |  |  ------------------
  ------------------
  393|     50|        } else {
  394|      4|            return -1;
  395|      4|        }
  396|       |
  397|     50|        if (len_processed + SIGNATURE_SIZE > length) {
  ------------------
  |  |   29|     50|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  ------------------
  |  |  |  |   29|     50|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  ------------------
  ------------------
  |  Branch (397:13): [True: 1, False: 49]
  ------------------
  398|      1|            return -1;
  399|      1|        }
  400|       |
  401|     49|        memcpy(sanctions[num].signature, &data[len_processed], SIGNATURE_SIZE);
  ------------------
  |  |   29|     49|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  ------------------
  |  |  |  |   29|     49|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  ------------------
  ------------------
  402|     49|        len_processed += SIGNATURE_SIZE;
  ------------------
  |  |   29|     49|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  ------------------
  |  |  |  |   29|     49|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  ------------------
  ------------------
  403|       |
  404|     49|        ++num;
  405|     49|    }
  406|       |
  407|      7|    if (length <= len_processed || length - len_processed < MOD_SANCTIONS_CREDS_SIZE) {
  ------------------
  |  |   33|      2|#define MOD_SANCTIONS_CREDS_SIZE (sizeof(uint32_t) + MOD_SANCTION_HASH_SIZE + sizeof(uint16_t) +\
  |  |  ------------------
  |  |  |  |   28|      2|#define MOD_SANCTION_HASH_SIZE CRYPTO_SHA256_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   75|      2|#define CRYPTO_SHA256_SIZE             32
  |  |  |  |  ------------------
  |  |  ------------------
  |  |   34|      2|                                       SIG_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  ------------------
  |  |  |  |   95|      2|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|      2|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  |  |                                                      SIG_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  ------------------
  |  |  |  |   29|      2|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   29|      2|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
  |  Branch (407:9): [True: 5, False: 2]
  |  Branch (407:36): [True: 1, False: 1]
  ------------------
  408|      6|        if (length != len_processed) {
  ------------------
  |  Branch (408:13): [True: 1, False: 5]
  ------------------
  409|      1|            return -1;
  410|      1|        }
  411|       |
  412|      5|        if (processed_data_len != nullptr) {
  ------------------
  |  |   63|      5|#define nullptr NULL
  ------------------
  |  Branch (412:13): [True: 5, False: 0]
  ------------------
  413|      5|            *processed_data_len = len_processed;
  414|      5|        }
  415|       |
  416|      5|        return num;
  417|      6|    }
  418|       |
  419|      1|    const uint16_t creds_len = sanctions_creds_unpack(creds, &data[len_processed]);
  420|       |
  421|      1|    if (creds_len != MOD_SANCTIONS_CREDS_SIZE) {
  ------------------
  |  |   33|      1|#define MOD_SANCTIONS_CREDS_SIZE (sizeof(uint32_t) + MOD_SANCTION_HASH_SIZE + sizeof(uint16_t) +\
  |  |  ------------------
  |  |  |  |   28|      1|#define MOD_SANCTION_HASH_SIZE CRYPTO_SHA256_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   75|      1|#define CRYPTO_SHA256_SIZE             32
  |  |  |  |  ------------------
  |  |  ------------------
  |  |   34|      1|                                       SIG_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  ------------------
  |  |  |  |   95|      1|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   34|      1|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  |  |  ------------------
  |  |  ------------------
  |  |                                                      SIG_PUBLIC_KEY_SIZE + SIGNATURE_SIZE)
  |  |  ------------------
  |  |  |  |   29|      1|#define SIGNATURE_SIZE CRYPTO_SIGNATURE_SIZE
  |  |  |  |  ------------------
  |  |  |  |  |  |   29|      1|#define CRYPTO_SIGNATURE_SIZE          64
  |  |  |  |  ------------------
  |  |  ------------------
  ------------------
  |  Branch (421:9): [True: 0, False: 1]
  ------------------
  422|      0|        return -1;
  423|      0|    }
  424|       |
  425|      1|    if (processed_data_len != nullptr) {
  ------------------
  |  |   63|      1|#define nullptr NULL
  ------------------
  |  Branch (425:9): [True: 1, False: 0]
  ------------------
  426|      1|        *processed_data_len = len_processed + creds_len;
  427|      1|    }
  428|       |
  429|      1|    return num;
  430|      1|}
group_moderation.c:compare_mod_pointers:
   45|  8.09k|{
   46|  8.09k|    const uint8_t *const *mod_a = (const uint8_t *const *)a;
   47|  8.09k|    const uint8_t *const *mod_b = (const uint8_t *const *)b;
   48|  8.09k|    return memcmp(*mod_a, *mod_b, SIG_PUBLIC_KEY_SIZE);
  ------------------
  |  |   95|  8.09k|#define SIG_PUBLIC_KEY_SIZE            CRYPTO_SIGN_PUBLIC_KEY_SIZE
  |  |  ------------------
  |  |  |  |   34|  8.09k|#define CRYPTO_SIGN_PUBLIC_KEY_SIZE    32
  |  |  ------------------
  ------------------
   49|  8.09k|}

LLVMFuzzerTestOneInput:
   40|     56|{
   41|     56|    tox::test::fuzz_select_target<TestModListUnpack, TestSanctionsListUnpack,
   42|     56|        TestSanctionCredsUnpack>(data, size);
   43|     56|    return 0;
   44|     56|}
group_moderation_fuzz_test.cc:_ZN12_GLOBAL__N_117TestModListUnpackERN3tox4test9Fuzz_DataE:
   12|     38|{
   13|     38|    CONSUME1_OR_RETURN(const std::uint16_t, num_mods, input);
  ------------------
  |  |  124|     38|    if ((INPUT).size() < sizeof(TYPE)) {      \
  |  |  ------------------
  |  |  |  Branch (124:9): [True: 1, False: 37]
  |  |  ------------------
  |  |  125|      1|        return;                               \
  |  |  126|      1|    }                                         \
  |  |  127|     38|    TYPE NAME = (INPUT).consume1(__func__)
  ------------------
   14|     37|    SimulatedEnvironment env;
   15|     37|    auto c_mem = env.fake_memory().c_memory();
   16|     37|    Moderation mods{&c_mem};
   17|     37|    mod_list_unpack(&mods, input.data(), input.size(), num_mods);
   18|     37|    mod_list_cleanup(&mods);
   19|     37|}
group_moderation_fuzz_test.cc:_ZN12_GLOBAL__N_123TestSanctionsListUnpackERN3tox4test9Fuzz_DataE:
   22|     15|{
   23|     15|    Mod_Sanction sanctions[10];
   24|     15|    Mod_Sanction_Creds creds;
   25|     15|    std::uint16_t processed_data_len;
   26|     15|    sanctions_list_unpack(sanctions, &creds, 10, input.data(), input.size(), &processed_data_len);
   27|     15|}
group_moderation_fuzz_test.cc:_ZN12_GLOBAL__N_123TestSanctionCredsUnpackERN3tox4test9Fuzz_DataE:
   30|      2|{
   31|      2|    CONSUME_OR_RETURN(const std::uint8_t *data, input, MOD_SANCTIONS_CREDS_SIZE);
  ------------------
  |  |  136|      2|    if ((INPUT).size() < (SIZE)) {           \
  |  |  ------------------
  |  |  |  Branch (136:9): [True: 1, False: 1]
  |  |  ------------------
  |  |  137|      1|        return;                              \
  |  |  138|      1|    }                                        \
  |  |  139|      2|    DECL = (INPUT).consume(__func__, (SIZE))
  ------------------
   32|      1|    Mod_Sanction_Creds creds;
   33|      1|    sanctions_creds_unpack(&creds, data);
   34|      1|}

mem_balloc:
   13|  1.76k|{
   14|  1.76k|    void *const ptr = mem->funcs->malloc_callback(mem->user_data, size);
   15|  1.76k|    return ptr;
   16|  1.76k|}
mem_alloc:
   25|     35|{
   26|     35|    void *const ptr = mem_balloc(mem, size);
   27|     35|    if (ptr != nullptr) {
  ------------------
  |  |   63|     35|#define nullptr NULL
  ------------------
  |  Branch (27:9): [True: 35, False: 0]
  ------------------
   28|     35|        memset(ptr, 0, size);
   29|     35|    }
   30|     35|    return ptr;
   31|     35|}
mem_valloc:
   34|     35|{
   35|     35|    const uint32_t bytes = nmemb * size;
   36|       |
   37|     35|    if (size != 0 && bytes / size != nmemb) {
  ------------------
  |  Branch (37:9): [True: 35, False: 0]
  |  Branch (37:22): [True: 0, False: 35]
  ------------------
   38|      0|        return nullptr;
  ------------------
  |  |   63|      0|#define nullptr NULL
  ------------------
   39|      0|    }
   40|       |
   41|     35|    void *const ptr = mem_alloc(mem, bytes);
   42|     35|    return ptr;
   43|     35|}
mem_delete:
   58|  1.76k|{
   59|  1.76k|    mem->funcs->dealloc_callback(mem->user_data, ptr);
   60|  1.76k|}

net_unpack_u16:
 2010|    230|{
 2011|    230|    const uint8_t hi = bytes[0];
 2012|    230|    const uint8_t lo = bytes[1];
 2013|    230|    *v = ((uint16_t)hi << 8) | lo;
 2014|    230|    return sizeof(*v);
 2015|    230|}
net_unpack_u32:
 2018|    114|{
 2019|    114|    const uint8_t *p = bytes;
 2020|    114|    uint16_t hi;
 2021|    114|    uint16_t lo;
 2022|    114|    p += net_unpack_u16(p, &hi);
 2023|    114|    p += net_unpack_u16(p, &lo);
 2024|    114|    *v = ((uint32_t)hi << 16) | lo;
 2025|    114|    return p - bytes;
 2026|    114|}
net_unpack_u64:
 2029|     56|{
 2030|     56|    const uint8_t *p = bytes;
 2031|     56|    uint32_t hi;
 2032|     56|    uint32_t lo;
 2033|     56|    p += net_unpack_u32(p, &hi);
 2034|     56|    p += net_unpack_u32(p, &lo);
 2035|     56|    *v = ((uint64_t)hi << 32) | lo;
 2036|     56|    return p - bytes;
 2037|     56|}

free_uint8_t_pointer_array:
   27|     73|{
   28|     73|    if (ary == nullptr) {
  ------------------
  |  |   63|     73|#define nullptr NULL
  ------------------
  |  Branch (28:9): [True: 38, False: 35]
  ------------------
   29|     38|        return;
   30|     38|    }
   31|       |
   32|  1.76k|    for (size_t i = 0; i < n_items; ++i) {
  ------------------
  |  Branch (32:24): [True: 1.72k, False: 35]
  ------------------
   33|  1.72k|        if (ary[i] != nullptr) {
  ------------------
  |  |   63|  1.72k|#define nullptr NULL
  ------------------
  |  Branch (33:13): [True: 1.72k, False: 0]
  ------------------
   34|  1.72k|            mem_delete(mem, ary[i]);
   35|  1.72k|        }
   36|  1.72k|    }
   37|       |
   38|     35|    mem_delete(mem, ary);
   39|     35|}

